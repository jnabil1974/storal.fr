import { openai } from '@ai-sdk/openai';
import { jsonSchema, streamText, tool } from 'ai';
// Import du catalogue dynamique avec coefficients de marge
import { CATALOG_SETTINGS, OPTIONS_PRICES, STORE_MODELS, FRAME_COLORS, FABRICS } from '@/lib/catalog-data';

// Define constants for backward compatibility
const PRODUCT_CATALOG = STORE_MODELS;
const OPTIONS_PRICING = OPTIONS_PRICES;
const STANDARD_COLORS = FRAME_COLORS.filter(c => c.category === 'standard');
const FABRIC_OPTIONS = FABRICS;
const DESIGN_OPTIONS = {
  fabrics: { category: 'dickson-orchestra' }
};

// Autoriser des rÃ©ponses plus longues si besoin (30s)
export const maxDuration = 30;

export async function POST(req: Request) {
  try {
    // 1. RÃ©cupÃ©rer les messages envoyÃ©s par le client
    const body = await req.json();
    const messages = body.messages || [];
    
    console.log('ğŸ“¥ Messages reÃ§us:', JSON.stringify(messages, null, 2));
    
    // Validation: s'assurer qu'il y a au moins un message
    if (!messages || messages.length === 0) {
      return new Response(JSON.stringify({ error: 'No messages provided' }), {
        status: 400,
        headers: { 'Content-Type': 'application/json' },
      });
    }

  // 2. GÃ©nÃ©ration du contexte dynamique pour l'IA (avec coefficients de marge)
  const catalogContext = Object.entries(PRODUCT_CATALOG).map(([key, model]) => {
    // Extract available projections (avancÃ©es) from buyPrices - with safety check
    const availableProjections = model.buyPrices ? Object.keys(model.buyPrices).sort((a, b) => Number(a) - Number(b)) : [];
    
    if (availableProjections.length === 0) {
      return `- ModÃ¨le ${model.name.toUpperCase()} : ${model.description}`;
    }
    
    const maxProjection = Math.max(...availableProjections.map(Number));
    
    // Extract max widths from the tier data - with safety check
    const allMaxWidths = availableProjections.flatMap(proj => {
      const projection = model.buyPrices[Number(proj)];
      return projection ? projection.map(tier => tier.maxW) : [];
    });
    const maxWidth = allMaxWidths.length > 0 ? Math.max(...allMaxWidths) : 'non spÃ©cifiÃ©e';
    
    return `- ModÃ¨le ${model.name.toUpperCase()} : ${model.description}
       Largeurs disponibles: jusqu'Ã  ${maxWidth}${typeof maxWidth === 'number' ? 'mm' : ''}.
       AvancÃ©es disponibles: ${availableProjections.map(p => p + 'mm').join(', ')}.
       (Note systÃ¨me : Coefficient de vente x${CATALOG_SETTINGS.COEFF_MARGE} appliquÃ© automatiquement).`;
  }).join('\n');

  const ledArmsPrices = OPTIONS_PRICES.LED_ARMS;
  const ledArmsFallbackKey = Number(Object.keys(ledArmsPrices)[0]) as keyof typeof ledArmsPrices;
  const ledArmsBasePrice = ledArmsPrices[2500] ?? ledArmsPrices[ledArmsFallbackKey];

  const optionsContext = `
- LED dans les bras: Ã€ partir de ${ledArmsBasePrice}â‚¬ selon avancÃ©e
- LED cassette/boÃ®tier: ${OPTIONS_PRICES.LED_CASSETTE}â‚¬
- Lambrequin manuel: Ã€ partir de ${OPTIONS_PRICES.LAMBREQUIN_ENROULABLE.MANUAL[0]?.price || 'variablÃ©'}â‚¬ selon dimensions
- Lambrequin motorisÃ©: Ã€ partir de ${OPTIONS_PRICES.LAMBREQUIN_ENROULABLE.MOTORIZED[0]?.price || 'variablÃ©'}â‚¬ selon dimensions
- Couleur RAL personnalisÃ©e: +${OPTIONS_PRICES.FRAME_SPECIFIC_RAL}â‚¬
`;

  const colorsContext = STANDARD_COLORS.map(color => 
    `- ${color.name} (${color.id})`
  ).join('\n');

  // GÃ©nÃ©rer le contexte des limites de chaque modÃ¨le
  const modelLimitsContext = Object.values(STORE_MODELS).map(model => {
    const maxWidth = model.compatibility?.max_width || 'non spÃ©cifiÃ©e';
    const maxProjection = model.compatibility?.max_projection || 'variable selon le modÃ¨le';
    return `- ${model.name} (${model.id}): Largeur max = ${maxWidth}mm, AvancÃ©e max = ${maxProjection}mm`;
  }).join('\n');

  // GÃ©nÃ©rer le contexte des compatibilitÃ©s OPTIONS pour chaque modÃ¨le
  const modelCompatibilityContext = Object.values(STORE_MODELS).map(model => {
    const options = [];
    if (model.compatibility.led_arms) options.push('âœ“ LED Bras');
    if (model.compatibility.led_box) options.push('âœ“ LED Coffre');
    if (model.compatibility.lambrequin_fixe) options.push('âœ“ Lambrequin Fixe');
    if (model.compatibility.lambrequin_enroulable) options.push('âœ“ Lambrequin Enroulable');
    
    const notAvailable = [];
    if (!model.compatibility.led_arms) notAvailable.push('âœ— LED Bras');
    if (!model.compatibility.led_box) notAvailable.push('âœ— LED Coffre');
    if (!model.compatibility.lambrequin_fixe) notAvailable.push('âœ— Lambrequin Fixe');
    if (!model.compatibility.lambrequin_enroulable) notAvailable.push('âœ— Lambrequin Enroulable');
    
    return `- ${model.name} (${model.id}): ${options.length > 0 ? options.join(', ') : 'Aucune option'} ${notAvailable.length > 0 ? '| NON DISPONIBLE: ' + notAvailable.join(', ') : ''}`;
  }).join('\n');

  // GÃ©nÃ©rer le contexte des couleurs autorisÃ©es pour les modÃ¨les PROMO
  const modelColorsContext = Object.values(STORE_MODELS)
    .filter(model => model.compatibility.allowed_colors)
    .map(model => {
      const allowedColorNames = model.compatibility.allowed_colors!
        .map(colorId => {
          const color = FRAME_COLORS.find(c => c.id === colorId);
          return color ? color.name : colorId;
        })
        .join(', ');
      return `- ${model.name} (${model.id}): COULEURS LIMITÃ‰ES â†’ ${allowedColorNames} UNIQUEMENT (pas de RAL custom)`;
    }).join('\n');

  // 3. PROMPT SYSTÃˆME (Expert Storal - Version OptimisÃ©e)
  const SYSTEM_PROMPT = `Tu es "Expert Storal", conseiller technique spÃ©cialisÃ© en stores bannes haut de gamme.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ COMPORTEMENT GÃ‰NÃ‰RAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš ï¸ RÃˆGLE #1 - FIDÃ‰LITÃ‰ AUX SÃ‰LECTIONS :
Quand le client dit "J'ai sÃ©lectionnÃ© X" ou confirme un choix via modal, ACCEPTE IMMÃ‰DIATEMENT. Ne redis JAMAIS "Voulez-vous..." pour un choix dÃ©jÃ  fait.

âš ï¸ RÃˆGLE #2 - COULEURS :
- Si le client demande Ã  VOIR les couleurs â†’ APPELLE open_color_selector (ne dis JAMAIS "Je choisis null")
- Si le client cite un RAL (ex: "anthracite" ou "7016") â†’ Confirme : "Couleur Anthracite RAL 7016 enregistrÃ©e âœ“"
- Pour modÃ¨les PROMO â†’ Limite forcÃ©e aux 3 standards (9016, 1015, 7016)

âš ï¸ RÃˆGLE #3 - DIMENSIONS :
Format d'entrÃ©e : "X et Y d'avancÃ©e" = X est LARGEUR, Y est AVANCÃ‰E
- LARGEUR = horizontale (parallÃ¨le au mur, ex: 8000mm)
- AVANCÃ‰E = perpendiculaire (sortie du store, ex: 4000mm)

Dimensions intermÃ©diaires ACCEPTÃ‰ES : Si client demande 3700mm (paliers 3500/4000), dis : "Parfait ! Nous rÃ©glerons l'armature 4000mm Ã  votre dimension exacte de 3700mm."

âš ï¸ RÃˆGLE #4 - LOI DES BRAS & BRAS CROISÃ‰S :
RÃˆGLE GÃ‰NÃ‰RALE : Largeur â‰¥ AvancÃ©e (configuration standard)
EXCEPTION : Si Largeur < AvancÃ©e (ex: 2000mm Ã— 2500mm)
â†’ DIS : "C'est tout Ã  fait possible ! Pour cette configuration, nous utiliserons des **bras croisÃ©s** (bras superposÃ©s) qui permettent une grande avancÃ©e sur une petite largeur. C'est une solution technique parfaitement fiable."
â†’ NE BLOQUE PAS la vente, signale simplement la technique utilisÃ©e.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š CATALOGUE - LIMITES PHYSIQUES PAR MODÃˆLE  
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

${modelLimitsContext}

âš ï¸ DISTINCTION CL Ã‰ : LARGEUR MAX STORE â‰  LARGEUR MAX LAMBREQUIN

Exemple BELHARRA :
- Largeur max STORE : 12 000mm (12m) âœ…
- Largeur max LAMBREQUIN ENROULABLE : 6 000mm (6m) âŒ

Si client demande un store 8m avec lambrequin enroulable :
â†’ "Votre store 8000mm est parfaitement rÃ©alisable. Par contre, le lambrequin enroulable est limitÃ© Ã  6m. Au-delÃ , je vous propose un lambrequin FIXE (droit ou vagues) qui apportera la mÃªme finition esthÃ©tique."

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ COMPATIBILITÃ‰S OPTIONS PAR MODÃˆLE (CRITIQUE !)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

${modelCompatibilityContext}

âš ï¸ RÃˆGLES D'EXCLUSION STRICTES :

1ï¸âƒ£ LAMBREQUIN (CRITIQUE - 3 CAS DISTINCTS) :
   
   A) KISSIMY / KITANGI / DYNASTA / BELHARRA (tous y compris PROMO) :
      â€¢ Lambrequin FIXE (Droit ou Vagues) disponible en option Ã  50 â‚¬ HT
      â€¢ âœ— JAMAIS de lambrequin motorisÃ©/enroulable
      â€¢ CONFIG_DATA : "lambrequin": true, "lambrequinMotorized": false (si client accepte)
      â€¢ Si client hÃ©site â†’ DIS : "Le lambrequin fixe apporte une finition esthÃ©tique (droit ou vagues au choix) pour un forfait de 50 â‚¬ HT. Souhaitez-vous l'ajouter ?"
   
   B) HELIOM :
      â€¢ âœ“ Lambrequin enroulable motorisÃ©/manuel disponible (option payante)
      â€¢ âœ“ Ou lambrequin fixe Ã  50 â‚¬ HT si le client prÃ©fÃ¨re (pas de motorisation)
      â€¢ CONFIG_DATA : "lambrequin": true, "lambrequinMotorized": true/false selon choix
   
   C) Largeur > 6000mm (tous modÃ¨les) :
      â€¢ âœ— Lambrequin enroulable impossible au-delÃ  de 6m
      â€¢ âœ“ Lambrequin fixe possible sans limite de largeur (forfait 50 â‚¬ HT)

2ï¸âƒ£ LED COFFRE :
   â€¢ KISSIMY / DYNASTA / BELHARRA PROMO â†’ âœ— Pas de LED coffre
   â€¢ HELIOM / BELHARRA std â†’ âœ“ LED coffre disponible

3ï¸âƒ£ LARGEUR > 6000mm :
   â€¢ Lambrequin enroulable â†’ âœ— Maximum 6000mm
   â€¢ Lambrequin fixe â†’ âœ“ Pas de limite (suit la largeur du store)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”„ PROCESSUS DE VENTE (9 Ã‰TAPES - AVEC DIAGNOSTIC)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ã‰TAPE 0 - DIAGNOSTIC COMMERCIAL (NOUVEAU !)
ğŸ¯ Avant de parler technique, pose ces questions pour CONSEILLER intelligemment :

â€¢ "Dans quelle rÃ©gion habitez-vous ?" (pour anticiper le vent)
â€¢ "Votre terrasse est exposÃ©e dans quelle direction ?" (Nord, Sud, Est, Ouest)
â€¢ "Ã€ quel moment de la journÃ©e profitez-vous de votre terrasse ?" (matin, aprÃ¨s-midi, soirÃ©e)

ğŸ§  INTELLIGENCE DE CONSEIL (utilise ces infos pour recommander au mieux) :

1ï¸âƒ£ EXPOSITION OUEST :
   â†’ Soleil violent l'aprÃ¨s-midi (surchauffe)
   â†’ RECOMMANDE VIVEMENT : Lambrequin enroulable (protection latÃ©rale du soleil rasant)
   â†’ DIS : "Avec une exposition Ouest, je vous conseil fortement un lambrequin enroulable. Il protÃ¨ge du soleil rasant de fin d'aprÃ¨s-midi qui passe sous le store."

2ï¸âƒ£ RÃ‰GION VENTÃ‰E (littoral, montagne, exposÃ©) :
   â†’ RECOMMANDE : ModÃ¨le BERLIN (Poids Lourd Classe 3 vent) + Capteur Eolis
   â†’ DIS : "Dans une rÃ©gion ventÃ©e, le modÃ¨le Berlin est idÃ©al : supports renforcÃ©s Classe 3 et capteur Eolis qui referme automatiquement le store en cas de rafale."

3ï¸âƒ£ PETITE HAUTEUR DE POSE (sous 2,30m) :
   â†’ RECOMMANDE : ModÃ¨les MONOBLOCS (Madrid ou Berlin)
   â†’ DIS : "Avec une faible hauteur, les monoblocs Madrid ou Berlin sont parfaits : pas de coffre, encombrement vertical rÃ©duit de 15 cm."

4ï¸âƒ£ GRANDE TERRASSE (> 8m de large) :
   â†’ RECOMMANDE : Dynasta, Belharra ou Berlin (largeur max 12m)
   â†’ DIS : "Pour une si belle terrasse, je vous conseille le [MODÃˆLE] qui peut couvrir jusqu'Ã  12 mÃ¨tres de large."

5ï¸âƒ£ BUDGET SERRÃ‰ (client cherche prix le plus bas) :
   â†’ RECOMMANDE : ModÃ¨le GÃˆNES (Traditionnel)
   â†’ DIS : "Pour maÃ®triser le budget, je vous conseille le GÃ¨nes, notre modÃ¨le traditionnel. C'est le store le plus Ã©conomique de notre gamme, parfait pour les balcons et petites terrasses."
   â†’ PRÃ‰CISE : "Attention : ce modÃ¨le nÃ©cessite une fixation solide aux deux extrÃ©mitÃ©s (pas de fixation murale unique). Il n'a pas de LED mais reste trÃ¨s fiable."
   â†’ Si budget serrÃ© ET grande largeur (> 6m) â†’ Propose MONTRÃ‰AL (Tradi renforcÃ© jusqu'Ã  12m)

6ï¸âƒ£ CONFIGURATION Ã‰TROITE (AvancÃ©e > Largeur) :
   â†’ RECOMMANDE : ModÃ¨le BRAS CROISÃ‰S (SpÃ©cialitÃ© exclusive)
   â†’ DIS : "Vous cherchez plus d'avancÃ©e que de largeur ? C'est exactement le cas pour lequel nous avons crÃ©Ã© le BRAS CROISÃ‰S ! Ses bras superposÃ©s se replient l'un au-dessus de l'autre pour cette configuration unique."
   â†’ DÃ‰TAIL : "Le BRAS CROISÃ‰S ce permet des avancÃ©es jusqu'Ã  3,5m mÃªme sur des balcons Ã©troits de 1m."
   â†’ AUTO-DETECT : Si l'utilisateur mentionne dimensions avec avancÃ©e > largeur, propose directement BRAS CROISÃ‰S

Ã‰TAPE 1 - ModÃ¨le (Recommandation Intelligente par Profils)

ğŸ¯ N'UTILISE JAMAIS LA QUESTION "CARRÃ‰ OU GALBÃ‰ ?" - C'EST OBSOLÃˆTE !

âš ï¸ RÃˆGLE D'HUMANISATION DU DIALOGUE :
   Si l'utilisateur donne des DIMENSIONS mais n'a PAS ENCORE choisi de profil/modÃ¨le :
   1. âŒ NE LANCE PAS open_model_selector immÃ©diatement - c'est trop brusque !
   2. âœ… RÃ‰PONDS D'ABORD par du CONSEIL :
      - Valide les dimensions : "5m x 4m est une belle surface pour crÃ©er un vrai espace ombragÃ©."
      - Pose une QUESTION D'ORIENTATION pour aider le choix :
        â†’ "Pour protÃ©ger efficacement votre terrasse, prÃ©fÃ©rez-vous un store avec **coffre intÃ©gral** (pour protÃ©ger la toile des intempÃ©ries) ou un modÃ¨le **sans coffre** (plus abordable et compact) ?"
        â†’ OU si grande largeur : "Avec cette largeur, souhaitez-vous un modÃ¨le avec coffre Ã©lÃ©gant ou un monobloc ultra-robuste ?"
   3. â³ ATTENDS la rÃ©ponse du client (il peut dire "avec coffre", "le plus Ã©conomique", "je ne sais pas", etc.)
   4. âœ… ENSUITE SEULEMENT, appelle open_model_selector avec le bon filter_type

Ã€ la place, utilise les infos du DIAGNOSTIC (Ã‰TAPE 0) pour recommander par PROFILS COMMERCIAUX :

ğŸ—ï¸ PROFIL 1 - DESIGN & PROTECTION MAXIMALE
   "Vous cherchez un store haut de gamme avec coffre intÃ©gral pour protÃ©ger la toile et les bras ?"
   â†’ Recommande : HELIOM, KISSIMY (les plus populaires) + LED bras/coffre en option
   â†’ APPELLE : open_model_selector avec filter_type="coffre"
   â†’ Message : "Ces modÃ¨les offrent un design Ã©lÃ©gant avec une protection 360Â° de la toile. Le coffre intÃ¨gre la motorisation de maniÃ¨re invisible. Souhaitez-vous explorer ?"

ğŸ›¡ï¸ PROFIL 2 - ROBUSTESSE ET GRANDE LARGEUR (> 6m)
   "Vous avez une grande terrasse ou vous avez besoin d'une solution robuste et compacte ?"
   â†’ Recommande : MADRID ou BERLIN (monoblocs renforcÃ©s jusqu'Ã  12m de large)
   â†’ APPELLE : open_model_selector avec filter_type="monobloc"
   â†’ Message : "Les monoblocs sont parfaits pour les grandes dimensions : pas de coffre, encombrement minimal, et mÃ©canisme ultra-fiable. IdÃ©al pour les terrasses gÃ©nÃ©reuses."

ğŸ’° PROFIL 3 - BUDGET OPTIMISÃ‰
   "Vous cherchez un excellent rapport qualitÃ©-prix pour un petit balcon ou terrasse ?"
   â†’ Recommande : GÃˆNES (budget) ou MONTRÃ‰AL (budget + grande largeur)
   â†’ APPELLE : open_model_selector avec filter_type="traditionnel"
   â†’ Message : "Les modÃ¨les traditionnels associent fiabilitÃ© et Ã©conomie. Parfaits pour les balcons et petites terrasses. L'installation est simple et la mÃ©canique Ã©prouvÃ©e depuis 30 ans."
   â†’ âš ï¸ AJOUTE : "Attention : ces modÃ¨les nÃ©cessitent une fixation solide aux DEUX extrÃ©mitÃ©s. Pas de LED, mais une durabilitÃ© exceptionnelle."

ğŸ§² PROFIL 4 - CONFIGURATION Ã‰TROITE (AvancÃ©e > Largeur)
   "Vous avez un balcon trÃ¨s Ã©troit mais vous cherchez beaucoup d'ombre ?"
   â†’ Recommande : BRAS CROISÃ‰S (spÃ©cialitÃ© exclusive, bras superposÃ©s)
   â†’ APPELLE : open_model_selector avec filter_type="specialite"
   â†’ Message : "Le BRAS CROISÃ‰S est conÃ§u exactement pour votre cas : bras superposÃ©s qui permettent une grande avancÃ©e mÃªme sur une petite largeur. Une solution technique innovante et fiable."

ğŸ”„ PROCESSUS :
1. Pose les questions du DIAGNOSTIC (Ã‰TAPE 0) si pas dÃ©jÃ  fait
2. Ã‰coute les rÃ©ponses (exposition, budget, dimensions, vent)
3. Si dimensions donnÃ©es mais pas de prÃ©fÃ©rence â†’ CONSEIL + QUESTION D'ORIENTATION (voir rÃ¨gle ci-dessus)
4. Propose le PROFIL qui correspond le mieux
5. APPELLE open_model_selector avec le bon filter_type
6. Ã€ la sÃ©lection â†’ Confirme immÃ©diatement : "Excellent choix ! Le [NOM] est..."
7. âŒ JAMAIS de question "carrÃ© ou galbÃ© ?" - on a dÃ©passÃ© ce stade !

Ã‰TAPE 2 - Dimensions
â€¢ Demande : "Quelle largeur et avancÃ©e envisagez-vous ?"
â€¢ VÃ©rifie max_width et max_projection du modÃ¨le

âš ï¸ RÃˆGLE SPÃ‰CIALE HELIOM :
  - Si client propose avancÃ©e > 3500 mm avec HELIOM standard â†’ DIS : "Pour une avancÃ©e de XXXX mm, nous allons passer sur le modÃ¨le **HELIOM+**, qui est Ã©quipÃ© de bras renforcÃ©s spÃ©cifiquement conÃ§us pour les grandes projections. C'est la meilleure option pour cette configuration."
  - METS Ã€ JOUR immÃ©diatement config_data.model â†’ "heliom_plus" (PAS besoin de redemander la confirmation, l'utilisateur a demandÃ© cette avancÃ©e)
  - Important : HELIOM+ supporteupporteporte jusqu'Ã  4000 mm d'avancÃ©e (vs 3500 mm pour HELIOM standard)

â€¢ Pour TOUS les autres modÃ¨les : Si hors limites â†’ Propose un modÃ¨le alternatif ou explique la limite

Ã‰TAPE 3 - Support
â€¢ "Fixation sur bÃ©ton, brique ou ITE ?"
â€¢ Si BÃ‰TON ou BRIQUE â†’ Fixation standard incluse
â€¢ Si ITE â†’ DIS : "Pour l'isolation extÃ©rieure, nous incluons un kit de fixation technique spÃ©cifique (type Thermax) pour garantir la sÃ©curitÃ© de l'installation. C'est inclus dans votre devis."

âš ï¸ SPÃ‰CIFICITÃ‰ MODÃˆLES TRADITIONNELS (GÃˆNES / MONTRÃ‰AL) :
â€¢ PrÃ©cise systÃ©matiquement : "Les modÃ¨les traditionnels nÃ©cessitent une fixation solide aux DEUX extrÃ©mitÃ©s du store (support d'extrÃ©mitÃ©s). VÃ©rifiez que votre mur peut accueillir ces supports sur toute la largeur."
â€¢ Si mur fragile ou placo â†’ Recommande plutÃ´t un modÃ¨le Coffre ou Monobloc (fixation murale centralisÃ©e)

Ã‰TAPE 4 - CÃ´tÃ© Sortie Moteur (OBLIGATOIRE)
â€¢ Demande : "De quel cÃ´tÃ© souhaitez-vous la sortie du cÃ¢ble moteur ? (En regardant le store de face, depuis l'extÃ©rieur : GAUCHE ou DROITE ?"
â€¢ Cette information est CRITIQUE pour la fabrication
â€¢ Par dÃ©faut, si le client hÃ©site : recommande DROITE (standard)
â€¢ Mets Ã  jour le JSON avec "motorSide": "gauche" ou "droite"

Ã‰TAPE 5 - Toile
â€¢ Recommande Orchestra (standard incluse)
â€¢ Si client veut choisir â†’ APPELLE open_fabric_selector
â€¢ Ã€ la sÃ©lection â†’ Confirme : "Parfait ! La toile [NOM] est un excellent choix."

Ã‰TAPE 6 - Couleur Structure
ğŸ¨ DÃ¨s que tu arrives Ã  cette Ã©tape (aprÃ¨s avoir collectÃ© modÃ¨le, dimensions, cÃ´tÃ© moteur, toile) :
â€¢ APPELLE IMMÃ‰DIATEMENT open_color_selector pour ouvrir le nuancier de couleurs
â€¢ NE POSE PAS de question "voulez-vous voir les couleurs ?" â†’ OUVRE DIRECTEMENT le sÃ©lecteur
â€¢ Exception UNIQUEMENT : Si le client a dÃ©jÃ  citÃ© un code RAL prÃ©cis (ex: "RAL 7016", "en anthracite RAL 7016"), alors confirme directement SANS ouvrir le sÃ©lecteur
â€¢ Recommandations populaires : RAL 7016 (anthracite), RAL 9016 (blanc)
â€¢ NE DIS JAMAIS "Je choisis la couleur null" - APPELLE TOUJOURS l'outil

âš ï¸ IMPORTANT : N'appelle cet outil QUE si tu as dÃ©jÃ  collectÃ© le modÃ¨le et les dimensions (Ã©tapes 2-3 complÃ¨tes)

Ã‰TAPE 7 - Options
â€¢ LED Bras : Si "âœ“ LED Bras" â†’ Propose (montant calculÃ© dans le rÃ©capitulatif)
â€¢ LED Coffre : SEULEMENT si "âœ“ LED Coffre" â†’ Propose (montant calculÃ© dans le rÃ©capitulatif)

âš ï¸ IMPORTANT : Les modÃ¨les TRADITIONNELS (GÃˆNES / MONTRÃ‰AL) ne peuvent PAS recevoir de LED (ni bras ni coffre). Ne propose JAMAIS l'option LED pour ces modÃ¨les.

â€¢ Auvent (NOUVEAU - Monoblocs ET Traditionnels !) :
  - Si modÃ¨le = MADRID ou BERLIN ou GÃˆNES ou MONTRÃ‰AL â†’ Propose l'auvent (toit de protection en aluminium)
  - Prix : 45 â‚¬ HT par mÃ¨tre linÃ©aire de largeur
  - DIS : "Je vous recommande l'auvent, un toit de protection en aluminium qui protÃ¨ge le mÃ©canisme des intempÃ©ries et prolonge la durÃ©e de vie. Prix : 45 â‚¬ HT par mÃ¨tre linÃ©aire."
  - CONFIG_DATA : "auvent": true|false
  - Si modÃ¨les COFFRE â†’ Ne propose PAS l'auvent (protection dÃ©jÃ  assurÃ©e par le coffre)

â€¢ Lambrequin : 
  - Si KISSIMY/KITANGI/DYNASTA/BELHARRA (tous) â†’ Propose UNIQUEMENT lambrequin fixe (50 â‚¬ HT) : "Souhaitez-vous ajouter un lambrequin fixe (droit ou vagues) pour une finition esthÃ©tique parfaite ? Forfait 50 â‚¬ HT."
  - Si MADRID/BERLIN (monoblocs) â†’ RECOMMANDE VIVEMENT le lambrequin fixe : "Pour un monobloc, le lambrequin fixe est essentiel : il protÃ¨ge les bras du soleil direct et des intempÃ©ries. Forfait 50 â‚¬ HT, je vous le conseille fortement."
  - Si GÃˆNES/MONTRÃ‰AL (traditionnels) â†’ RECOMMANDE Ã‰GALEMENT le lambrequin fixe : "Pour un modÃ¨le traditionnel, le lambrequin fixe protÃ¨ge les bras et amÃ©liore le rendu esthÃ©tique. Forfait 50 â‚¬ HT."
  - Si HELIOM ET largeur â‰¤ 6m â†’ Propose lambrequin enroulable (motorisÃ©/manuel) OU lambrequin fixe (50 â‚¬ HT)
    * Si client choisit lambrequin ENROULABLE â†’ Propose systÃ©matiquement le sÃ©lecteur de toile technique Soltis : "Pour votre lambrequin enroulable, je vous propose de choisir une toile technique Soltis. La Soltis 86 est idÃ©ale pour garder la vue sur votre jardin tout en protÃ©geant du soleil, tandis que la Soltis 92 est plus opaque et offre une meilleure performance thermique. Souhaitez-vous ouvrir le nuancier Soltis ?"
    
    ğŸ”¶ PRIORITÃ‰ LAMBREQUIN - RÃˆGLE IMPORTANTE :
    DÃ¨s que tu as proposÃ© le lambrequin enroulable (Soltis), si le client dit :
    - "Je veux voir les toiles"
    - "Nuancier"
    - "Choisir la toile"
    - "Voir les couleurs"
    - "Montrez-moi les options"
    APPELLE IMMÃ‰DIATEMENT open_lambrequin_fabric_selector (pas open_fabric_selector !!)
    
    Cette rÃ¨gle s'applique TANT QUE nous sommes en Ã‰TAPE 7 (discussion lambrequin).
    
  - Si largeur > 6m â†’ Propose uniquement lambrequin fixe (50 â‚¬ HT)
  
â€¢ Capteurs : Vent Eolis, Soleil Sunis (options disponibles, montant dans le rÃ©capitulatif)
  - Si rÃ©gion ventÃ©e (dÃ©tectÃ©e en Ã‰TAPE 0) â†’ RECOMMANDE VIVEMENT Eolis

Ã‰TAPE 8 - Closing
Une fois TOUTES les infos collectÃ©es :
1. Liste le rÃ©capitulatif
2. Ajoute badges : BADGE:{"type":"promo","label":"Cadeau : -5% avec ${CATALOG_SETTINGS.promoCode}"}
3. GÃ©nÃ¨re CONFIG_DATA:{...} (voir format ci-dessous)
4. Demande : "Voulez-vous que je l'ajoute au panier ?"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ FORMAT JSON CONFIG_DATA (Ã‰TAPE 8 - OBLIGATOIRE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CONFIG_DATA:{"model":"ID_EXACT","width":LARGEUR_MM,"projection":AVANCEE_MM,"color":"ral_CODE","fabric_id":"REF","support":"beton|brique|ite","motorSide":"gauche|droite","motor":"io","sensor":""|"wind"|"sun","ledArms":true|false,"ledBox":true|false,"auvent":true|false,"lambrequin":true|false,"lambrequinMotorized":true|false,"lambrequin_fabric_id":""|"SOL-86"|"SOL-92","price":0}

REMARQUES : 
- "auvent" : OBLIGATOIRE pour Madrid/Berlin (monoblocs), false pour autres modÃ¨les
- "lambrequin_fabric_id" : OBLIGATOIRE UNIQUEMENT si lambrequin:true ET lambrequinMotorized:true (lambrequin enroulable)

Exemples :
â€¢ HELIOM 8mÃ—4m, Anthracite, Moteur DROITE, LED Bras+Coffre, Lambrequin enroulable motorisÃ© avec Soltis 86 :
CONFIG_DATA:{"model":"heliom","width":8000,"projection":4000,"color":"ral_7016","fabric_id":"orc_0001","support":"beton","motorSide":"droite","motor":"io","sensor":"","ledArms":true,"ledBox":true,"auvent":false,"lambrequin":true,"lambrequinMotorized":true,"lambrequin_fabric_id":"SOL-86-TEST","price":0}

â€¢ BERLIN 10mÃ—4m (Monobloc), Blanc, Moteur GAUCHE, LED Bras, AVEC Auvent + Lambrequin FIXE :
CONFIG_DATA:{"model":"berlin","width":10000,"projection":4000,"color":"ral_9016","fabric_id":"orc_0001","support":"beton","motorSide":"gauche","motor":"io","sensor":"wind","ledArms":true,"ledBox":false,"auvent":true,"lambrequin":true,"lambrequinMotorized":false,"lambrequin_fabric_id":"","price":0}

â€¢ KISSIMY 3588Ã—2500, Blanc, Moteur GAUCHE, LED Bras, AVEC Lambrequin FIXE (50 â‚¬ HT) :
CONFIG_DATA:{"model":"kissimy","width":3588,"projection":2500,"color":"ral_9016","fabric_id":"orc_0001","support":"beton","motorSide":"gauche","motor":"io","sensor":"","ledArms":true,"ledBox":false,"auvent":false,"lambrequin":true,"lambrequinMotorized":false,"lambrequin_fabric_id":"","price":0}

â€¢ MADRID 6mÃ—3m (Monobloc), Moteur DROITE, LED Bras, SANS Auvent, SANS Lambrequin :
CONFIG_DATA:{"model":"madrid","width":6000,"projection":3000,"color":"ral_7016","fabric_id":"orc_0001","support":"beton","motorSide":"droite","motor":"io","sensor":"","ledArms":true,"ledBox":false,"auvent":false,"lambrequin":false,"lambrequinMotorized":false,"lambrequin_fabric_id":"","price":0}

REMARQUE : Pour KISSIMY/KITANGI/DYNASTA/BELHARRA, "lambrequin":true + "lambrequinMotorized":false = lambrequin fixe Ã  50 â‚¬ HT.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ’¬ GESTION DES OBJECTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Prix â†’ "C'est un investissement, mais l'aluminium renforcÃ© garantit 20 ans de durÃ©e, pas 3 saisons."
Vent â†’ "Certification Classe 3. Avec le capteur Eolis, le store se referme automatiquement."
BADGE:{"type":"safety","label":"Capteur Vent Eolis"}

Pose â†’ "Notre forfait Pose SÃ©rÃ©nitÃ© inclut TVA rÃ©duite 10% (produit+pose)."
BADGE:{"type":"tva","label":"TVA 10% Ã©ligible"}

Entretien â†’ "Toiles DicksonÂ® dÃ©perlantes : l'eau perle et emporte les poussiÃ¨res."
BADGE:{"type":"fabric","label":"DicksonÂ® Premium"}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ BADGES DISPONIBLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BADGE:{"type":"guarantee","label":"Garantie 12 ans"}
BADGE:{"type":"tva","label":"TVA 10% Ã©ligible"}
BADGE:{"type":"wind","label":"Classe 3 Vent"}
BADGE:{"type":"fabric","label":"DicksonÂ® Premium"}
BADGE:{"type":"tech","label":"Moteur SomfyÂ® io"}
BADGE:{"type":"safety","label":"Capteur Vent Eolis"}
BADGE:{"type":"smart","label":"Compatible TaHoma"}
BADGE:{"type":"promo","label":"Cadeau : -5% avec ${CATALOG_SETTINGS.promoCode}"}
BADGE:{"type":"success","label":"Livraison gratuite sous 7 jours"}
  `;

  // 4. Lancer la gÃ©nÃ©ration de rÃ©ponse
  console.log('ğŸ”„ PrÃ©paration des messages pour OpenAI...');
  console.log('Messages reÃ§us:', JSON.stringify(messages, null, 2));

  // Enrichir les tool results avec les donnÃ©es complÃ¨tes des modÃ¨les/toiles
  const enrichedMessages = Array.isArray(messages)
    ? messages.map((msg: any) => {
        if (msg.role === 'assistant' && Array.isArray(msg.parts)) {
          const enrichedParts = msg.parts.map((part: any) => {
            // Enrichir open_model_selector results
            if (part.type === 'tool-open_model_selector' && part.output && typeof part.output === 'object') {
              if (part.output.id && !part.output.name) {
                const model = Object.values(STORE_MODELS).find((m) => m.id === part.output.id);
                if (model) {
                  console.log('ğŸ”„ Enriching model result:', part.output.id, 'â†’', model.name);
                  return {
                    ...part,
                    output: {
                      id: model.id,
                      name: model.name,
                      type: model.type,
                      shape: model.shape,
                      description: model.description,
                    }
                  };
                }
              }
            }
            // Enrichir open_fabric_selector results
            if (part.type === 'tool-open_fabric_selector' && part.output && typeof part.output === 'object') {
              if (part.output.fabric_id) {
                const fabric = FABRIC_OPTIONS.find((f: any) => f.id === part.output.fabric_id);
                if (fabric) {
                  console.log('ğŸ”„ Enriching fabric result:', part.output.fabric_id, 'â†’', fabric.name);
                  return {
                    ...part,
                    output: {
                      fabric_id: fabric.id,
                      name: fabric.name,
                      ref: fabric.ref,
                    }
                  };
                }
              }
            }
            return part;
          });
          return { ...msg, parts: enrichedParts };
        }
        return msg;
      })
    : messages;

  const normalizedMessages = Array.isArray(enrichedMessages)
    ? enrichedMessages.map((msg: any) => {
        if (typeof msg?.content === 'string') {
          return { role: msg.role, content: msg.content };
        }
        if (Array.isArray(msg?.content)) {
          const text = msg.content
            .filter((part: any) => part.type === 'text')
            .map((part: any) => part.text)
            .join('');
          return { role: msg.role, content: text };
        }
        if (Array.isArray(msg?.parts)) {
          const text = msg.parts
            .filter((part: any) => part.type === 'text')
            .map((part: any) => part.text)
            .join('');
          return { role: msg.role, content: text };
        }
        return { role: msg?.role ?? 'user', content: '' };
      })
    : [];

  console.log('âœ… Messages normalisÃ©s:', JSON.stringify(normalizedMessages, null, 2));

  // âš ï¸ DÃ‰TECTION INTELLIGENTE D'INTENTION (avec prioritÃ©s)
  const lastUserMessage = normalizedMessages[normalizedMessages.length - 1]?.content?.toLowerCase() || '';
  
  console.log('ğŸ” Analysant le message:', lastUserMessage);
  
  // ğŸ”§ EXTRACTION DU MODÃˆLE ACTUEL ET DES DIMENSIONS DEPUIS LA CONVERSATION
  // Parser config_data depuis les messages d'assistant
  let currentModel: string | undefined;
  let currentProjection: number | undefined;
  
  for (let i = normalizedMessages.length - 1; i >= 0; i--) {
    const msg = normalizedMessages[i];
    if (msg.role === 'assistant' && msg.content.includes('CONFIG_DATA:')) {
      const configMatch = msg.content.match(/CONFIG_DATA:\{([^}]+)\}/);
      if (configMatch) {
        try {
          const configStr = '{' + configMatch[1] + '}';
          // Parse manually for robustness
          const modelMatch = configStr.match(/"model":"([^"]+)"/);
          if (modelMatch) currentModel = modelMatch[1];
          const projMatch = configStr.match(/"projection":(\d+)/);
          if (projMatch) currentProjection = Number(projMatch[1]);
        } catch (e) {
          console.log('âš ï¸ Impossible de parser config_data');
        }
      }
      break;
    }
  }
  
  // Extraire les dimensions du message utilisateur (si mentionnÃ©es)
  // Format attendu: "X et Y d'avancÃ©e" ou "X par Y" ou "X x Y"
  let userProjection: number | undefined;
  const dimensionMatches = lastUserMessage.match(/(\d{3,5})\s*(?:et|x|par|mm|\s)+(\d{3,5})\s*mm?/i);
  if (dimensionMatches) {
    // Le deuxiÃ¨me nombre est l'avancÃ©e
    userProjection = Number(dimensionMatches[2]);
    console.log('ğŸ“ Dimensions dÃ©tectÃ©es: largeur=' + dimensionMatches[1] + ', avancÃ©e=' + userProjection);
  }
  
  // ğŸ”¶ DÃ‰TECTION HELIOM â†’ HELIOM+ (rÃ¨gle de mÃ©tier spÃ©cifique)
  let shouldUpgradeToHeliumPlus = false;
  let heliumUpgradeContext = '';
  
  if (currentModel === 'heliom' && userProjection && userProjection > 3500) {
    shouldUpgradeToHeliumPlus = true;
    heliumUpgradeContext = `\n\nâš ï¸ RÃˆGLE DÃ‰TECTÃ‰E : L'utilisateur a demandÃ© une avancÃ©e de ${userProjection}mm avec le modÃ¨le HELIOM.
    â¡ï¸ HELIOM max = 3500mm â†’ UPGRADE AUTOMATIQUE vers HELIOM+ (max 4000mm)
    ACTIONS REQUISES:
    1. RECOMMANDE: "Pour une avancÃ©e de ${userProjection}mm, nous allons passer sur le modÃ¨le **HELIOM+**, Ã©quipÃ© de bras renforcÃ©s spÃ©cifiquement conÃ§us pour les grandes projections."
    2. FORCE config_data.model: "heliom_plus" (NE REDEMANDE PAS de confirmation au client - il a demandÃ© cette avancÃ©e)
    3. CONTINUE normalement vers l'Ã©tape suivante (support, couleur, etc.)`;
    console.log('ğŸ”¶ DÃ©tection HELIOM upgrade:', shouldUpgradeToHeliumPlus);
  }

  // ğŸ§² DÃ‰TECTION CONFIGURATION Ã‰TROITE (AvancÃ©e > Largeur)
  // Extrait les dimensions mentionnÃ©es par l'utilisateur
  const dimensionPatterns = [
    /(\d+)\s*(?:cm|m|mm)?\s*(?:de)?\s*(?:largeur|large|width|Ã—|x)\s*(?:et|x|par)?\s*(\d+)\s*(?:cm|m|mm)?\s*(?:d')?\s*(?:avancÃ©e|profondeur|depth|projection)/i,
    /(\d+)\s*(?:cm|m|mm)?\s*(?:d')?\s*(?:avancÃ©e|profondeur|depth|projection)\s*(?:et|x|par)?\s*(\d+)\s*(?:cm|m|mm)?\s*(?:de)?\s*(?:largeur|large|width)/i,
  ];
  
  let hasProjectionGreaterThanWidth = false;
  for (const pattern of dimensionPatterns) {
    const match = lastUserMessage.match(pattern);
    if (match) {
      const val1 = parseInt(match[1], 10);
      const val2 = parseInt(match[2], 10);
      // Dans le premier pattern : val1=largeur, val2=avancÃ©e
      if (pattern === dimensionPatterns[0]) {
        if (val2 > val1) hasProjectionGreaterThanWidth = true;
      }
      // Dans le deuxiÃ¨me pattern : val1=avancÃ©e, val2=largeur
      if (pattern === dimensionPatterns[1]) {
        if (val1 > val2) hasProjectionGreaterThanWidth = true;
      }
    }
  }
  console.log('ğŸ§² hasProjectionGreaterThanWidth:', hasProjectionGreaterThanWidth);

  // DÃ©tecter si l'assistant a posÃ© une question sur les couleurs et que l'utilisateur rÃ©pond "oui"
  const lastAssistantMessage = normalizedMessages.length >= 2 
    ? normalizedMessages[normalizedMessages.length - 2]?.content?.toLowerCase() || ''
    : '';
  
  // VÃ©rifier si c'est une confirmation de sÃ©lection (rÃ©sultat d'addToolResult)
  const isSelectionConfirmation = /(sÃ©lectionnÃ©|j'ai choisi|je choisis)/i.test(lastUserMessage);
  console.log('ğŸ” isSelectionConfirmation:', isSelectionConfirmation, 'regex test result');
  
  // VÃ©rifier si on est en phase de closing (rÃ©capitulatif + demande d'ajout au panier)
  const isClosingPhase = /\b(ajouter au panier|voulez-vous que je l'ajoute|rÃ©capitulatif|config_data|souhaitez-vous finaliser|commander)\b/i.test(lastAssistantMessage);
  console.log('ğŸ” isClosingPhase:', isClosingPhase);

  // ğŸ§² DÃ‰TECTION BRAS CROISÃ‰S (configuration Ã©troite : avancÃ©e > largeur)
  let brasCroisesContext = '';
  const brasCroisesDetected = 
    hasProjectionGreaterThanWidth && 
    !currentModel && // Seulement si pas encore de modÃ¨le sÃ©lectionnÃ©
    !isClosingPhase &&
    !isSelectionConfirmation;
  
  if (brasCroisesDetected) {
    brasCroisesContext = `\n\nğŸ§² CONFIGURATION DÃ‰TECTÃ‰E : AvancÃ©e > Largeur (configuration Ã©troite)
    â¡ï¸ Le modÃ¨le IDÃ‰AL : **BRAS CROISÃ‰S** (SpÃ©cialitÃ© exclusive)
    ACTIONS REQUISES:
    1. RECOMMANDE IMMÃ‰DIATEMENT: "Vous cherchez plus d'avancÃ©e que de largeur ? C'est exactement le cas pour lequel nous avons crÃ©Ã© le **BRAS CROISÃ‰S** ! Sa mÃ©canique spÃ©ciale avec bras superposÃ©s se replie l'un au-dessus de l'autre pour cette configuration unique."
    2. AJOUTE: "Le BRAS CROISÃ‰S permet des projections jusqu'Ã  3,5 mÃ¨tres mÃªme sur des balcons trÃ¨s Ã©troits."
    3. PROPOSE open_model_selector avec FILTRE type="specialite" (FORCE le BRAS CROISÃ‰S Ã  Ãªtre en Ã©vidence)
    4. NE FAIS PAS d'autres recommandations de modÃ¨les pour cette configuration`;
    console.log('ğŸ§² DÃ©tection BRAS CROISÃ‰S:', brasCroisesDetected);
  }
  
  // VÃ©rifier si c'est le dÃ©but de la conversation (demande initiale de store)
  const isInitialRequest = normalizedMessages.length <= 2 && /\b(proposez|proposer|conseille|besoin|veux|cherche|intÃ©ressÃ©|store|banne)\b/i.test(lastUserMessage);
  console.log('ğŸ” isInitialRequest:', isInitialRequest, 'messageCount:', normalizedMessages.length);
  
  // DÃ©tecter si on parle d'OPTIONS plutÃ´t que de sÃ©lection de modÃ¨le
  const isOptionsContext = /\b(led|Ã©clairage|lumiÃ¨re|lambrequin|option|capteur|moteur|motorisÃ©)\b/i.test(lastUserMessage);
  console.log('ğŸ” isOptionsContext:', isOptionsContext);
  
  // VÃ©rifier si on est en Ã‰TAPE 7 (options : lambrequin, LED, capteurs) - NE PAS confondre avec Ã‰TAPE 6 (couleur)
  const isOptionsPhase = /\b(lambrequin|led|capteur|eolis|sunis|option)\b/i.test(lastAssistantMessage);
  console.log('ğŸ” isOptionsPhase:', isOptionsPhase);
  
  const isYesAfterColorQuestion = /\b(oui|ok|d'accord|volontiers|affiche|montre)\b/i.test(lastUserMessage) 
    && /\b(couleur|ral|teinte|nuancier|options disponibles|prÃ©fÃ©rence)\b/i.test(lastAssistantMessage)
    && !isClosingPhase 
    && !isOptionsPhase; // âœ… Ne pas dÃ©clencher si on est en Ã‰TAPE 7 (options)
  console.log('ğŸ” isYesAfterColorQuestion:', isYesAfterColorQuestion, 'based on lastAssistantMessage:', lastAssistantMessage.substring(0, 100));
  
  // PRIORITÃ‰ 1 : DÃ©tection COULEUR (sauf si c'est une confirmation OU une demande initiale)
  const hasColorKeyword = !isSelectionConfirmation && !isInitialRequest && (
    /\b(couleur|ral|anthracite|gris|blanc|beige|teinte|peinture|Ã©chantillon|nuancier)\b/i.test(lastUserMessage) ||
    (/(armature|structure|coffre)\s+(couleur|ral|teinte)/i.test(lastUserMessage)) || // "structure couleur" mais pas juste "structure"
    isYesAfterColorQuestion
  );
  console.log('ğŸ¨ hasColorKeyword:', hasColorKeyword, 'lastUserMessage:', lastUserMessage);
  
  // ğŸ”¶ DÃ‰TECTION CONTEXTE LAMBREQUIN (on est en Ã‰TAPE 7 : options lambrequin)
  // Si l'assistant a mentionnÃ© "lambrequin enroulable", "toile technique Soltis" rÃ©cemment
  const isLambrequinContext = /\b(lambrequin enroulable|soltis|toile technique|lambrequin motorisÃ©|lambrequin manuel)\b/i.test(lastAssistantMessage);
  console.log('ğŸ”¶ isLambrequinContext:', isLambrequinContext);
  
  // PRIORITÃ‰ 2 : DÃ©tection TOILE LAMBREQUIN
  // Cas 1: Mention explicite "lambrequin + toile" dans le message utilisateur
  // Cas 2: Demande de voir les toiles ALORS QU'ON EST en contexte lambrequin (Ã‰TAPE 7)
  const hasLambrequinFabricKeyword = !isSelectionConfirmation && (
    (/\b(lambrequin).*(toile|tissu|soltis)/i.test(lastUserMessage) ||
     /\b(toile|tissu|soltis).*(lambrequin)/i.test(lastUserMessage)) ||
    // ğŸ”¶ NOUVEAU: Si on est en contexte lambrequin ET l'utilisateur demande Ã  voir les toiles
    (isLambrequinContext && /\b(voir|montrer|nuancier|choix|choisir|sÃ©lection|catalogue).*(toile|tissu|couleur)|toile|tissu|soltis/i.test(lastUserMessage))
  );
  console.log('ğŸ­ hasLambrequinFabricKeyword:', hasLambrequinFabricKeyword, '(context:', isLambrequinContext, ')');
  
  // PRIORITÃ‰ 3 : DÃ©tection TOILE PRINCIPALE (seulement si demande explicite de sÃ©lection)
  // âš ï¸ IMPORTANT: Ne dÃ©clencher que si PAS en contexte lambrequin
  const hasFabricKeyword = !isSelectionConfirmation && !hasLambrequinFabricKeyword && !isLambrequinContext && (
    /\b(quelle|quel|choix|choisir|sÃ©lection|Ã©chantillon|voir|montrer|catalogue).*(toile|tissu)/i.test(lastUserMessage) ||
    /\b(toile|tissu).*(quelle|quel|choix|choisir|sÃ©lection|Ã©chantillon|voir|montrer|catalogue)/i.test(lastUserMessage)
  );
  
  // PRIORITÃ‰ 4 : DÃ‰TECTION PROFIL MODÃˆLE (remplace l'ancienne dÃ©tection "carrÃ©/galbÃ©")
  // DÃ©tecte le PROFIL COMMERCIAL plutÃ´t que la forme
  
  // Profil 1 : DESIGN & PROTECTION = Coffres (Heliom, Kissimy)
  const hasDesignKeywords = /\b(design|haut de gamme|design Ã©lÃ©gant|protection|coffre|protÃ©ger|premium|luxe|esthÃ©tique)\b/i.test(lastUserMessage);
  
  // Profil 2 : ROBUSTESSE & GRANDES DIMENSIONS = Monoblocs (Madrid, Berlin)
  const hasRobustnessKeywords = /\b(grand|robuste|grande largeur|12m|large|compact|peu encombrant|12 mÃ¨tres|gÃ©nÃ©reuse|terrasse grande)\b/i.test(lastUserMessage);
  
  // Profil 3 : BUDGET OPTIMISÃ‰ = Traditionnels (GÃ¨nes, MontrÃ©al)
  const hasBudgetKeywords = /\b(budget|Ã©conomique|prix|pas cher|petit|balcon|abordable|Ã©conomies|limitÃ©)\b/i.test(lastUserMessage);
  
  // Profil 4 : Configuration Ã‰troite dÃ©tectÃ©e sÃ©paremment via hasProjectionGreaterThanWidth (avant)
  
  let detectedProfileType: 'coffre' | 'monobloc' | 'traditionnel' | 'specialite' | undefined;
  
  if (hasProjectionGreaterThanWidth) {
    detectedProfileType = 'specialite';
  } else if (hasDesignKeywords && !hasBudgetKeywords) {
    detectedProfileType = 'coffre';
  } else if (hasRobustnessKeywords && !hasBudgetKeywords) {
    detectedProfileType = 'monobloc';
  } else if (hasBudgetKeywords) {
    detectedProfileType = 'traditionnel';
  }

  console.log('ğŸ¯ DÃ©tection PROFIL:', {
    hasDesignKeywords,
    hasRobustnessKeywords,
    hasBudgetKeywords,
    hasProjectionGreaterThanWidth,
    detectedProfileType
  });

  const hasModelKeyword = detectedProfileType !== undefined && !isSelectionConfirmation && !isOptionsContext;
  
  // DÃ©terminer quel outil forcer (par prioritÃ©)
  type ToolName = 'open_color_selector' | 'open_lambrequin_fabric_selector' | 'open_fabric_selector' | 'open_model_selector';
  let forcedToolName: ToolName | undefined;
  if (hasColorKeyword) {
    forcedToolName = 'open_color_selector';
    console.log('ğŸ¨ DÃ©tection : COULEUR â†’ FORCER open_color_selector');
  } else if (hasLambrequinFabricKeyword) {
    forcedToolName = 'open_lambrequin_fabric_selector';
    console.log('ğŸ­ DÃ©tection : TOILE LAMBREQUIN â†’ FORCER open_lambrequin_fabric_selector');
  } else if (hasFabricKeyword) {
    forcedToolName = 'open_fabric_selector';
    console.log('ğŸ§µ DÃ©tection : TOILE PRINCIPALE â†’ FORCER open_fabric_selector');
  } else if (hasModelKeyword) {
    forcedToolName = 'open_model_selector';
    console.log('ğŸ  DÃ©tection : MODÃˆLE â†’ FORCER open_model_selector');
  }
  
  const shouldTriggerTool = !!forcedToolName;
  
  console.log('ğŸ” === RÃ‰SULTAT DÃ‰TECTION ===');
  console.log('   lastUserMessage:', lastUserMessage);
  console.log('   hasColorKeyword:', hasColorKeyword);
  console.log('   hasLambrequinFabricKeyword:', hasLambrequinFabricKeyword);
  console.log('   hasFabricKeyword:', hasFabricKeyword);
  console.log('   hasModelKeyword:', hasModelKeyword);
  console.log('   forcedToolName:', forcedToolName);
  console.log('   shouldTriggerTool:', shouldTriggerTool);
  console.log('===========================');

  console.log('ğŸ¤– Appel OpenAI avec gpt-4o...');
  
  // CrÃ©er un systÃ¨me prompt enrichi avec le contexte d'upgrade HELIOM et BRAS CROISÃ‰S si nÃ©cessaire
  let enrichedSystemPrompt = SYSTEM_PROMPT;
  if (shouldUpgradeToHeliumPlus) {
    enrichedSystemPrompt = SYSTEM_PROMPT + heliumUpgradeContext;
  }
  if (brasCroisesDetected) {
    enrichedSystemPrompt = SYSTEM_PROMPT + brasCroisesContext;
  }
  
  const result = streamText({
    model: openai('gpt-4o'),
    system: enrichedSystemPrompt,
    messages: normalizedMessages,
    temperature: 0.7,
    maxTokens: 2000,
    toolChoice: shouldTriggerTool ? { 
      type: 'required', // FORCE l'utilisation d'un outil
      toolName: forcedToolName! 
    } : 'auto',
    tools: {
      open_color_selector: tool({
        description: "APPELLE CET OUTIL Ã  l'Ã‰TAPE 6 (Couleur Structure) une fois que tu as collectÃ© : modÃ¨le + dimensions + cÃ´tÃ© moteur + toile. APPELLE aussi si le client dit 'oui/ok' aprÃ¨s que tu as mentionnÃ© les couleurs. NE L'APPELLE PAS au dÃ©but de la conversation ou avant d'avoir collectÃ© les infos de base. EXEMPLES : arriver Ã  l'Ã©tape couleur aprÃ¨s avoir les dimensions, 'Affichez-moi les couleurs', 'Quelles couleurs disponibles ?', 'oui' (aprÃ¨s question couleur). NE DIS JAMAIS 'Je choisis la couleur null'. EXCEPTION : Si client cite un RAL prÃ©cis, ne l'appelle pas.",
        inputSchema: jsonSchema({
          type: 'object',
          properties: {
            category: {
              type: 'string',
              description: "CatÃ©gorie de couleurs Ã  afficher (ex: standard, all, reds).",
            },
          },
          required: [],
        }),
      }),
      open_model_selector: tool({
        description: "Ouvre le comparateur visuel des modÃ¨les de stores. APPELLE CET OUTIL dÃ¨s que tu as identifiÃ© le PROFIL du client : âœ“ DESIGN & PROTECTION (filter_type='coffre') â†’ Heliom, Kissimy avec protection intÃ©grale âœ“ ROBUSTESSE & GRANDES DIMENSIONS (filter_type='monobloc') â†’ Madrid, Berlin, compacts et renforcÃ©s âœ“ BUDGET OPTIMISÃ‰ (filter_type='traditionnel') â†’ GÃ¨nes, MontrÃ©al, excellent rapport qualitÃ©-prix âœ“ CONFIGURATION Ã‰TROITE (filter_type='specialite') â†’ Bras CroisÃ©s, pour avancÃ©e > largeur. N'Ã©cris JAMAIS le nom du modÃ¨le, laisse le client choisir visuellement. APRÃˆS sÃ©lection, CONFIRME IMMÃ‰DIATEMENT son choix avec enthousiasme.",
        inputSchema: jsonSchema({
          type: 'object',
          properties: {
            filter_type: {
              type: 'string',
              enum: ['coffre', 'monobloc', 'traditionnel', 'specialite'],
              description: "Profil commercial : 'coffre' pour design+protection, 'monobloc' pour robustesse+compacitÃ©, 'traditionnel' pour budget, 'specialite' pour configurations spÃ©ciales (bras croisÃ©s).",
            },
          },
          required: ['filter_type'],
        }),
      }),
      open_fabric_selector: tool({
        description: "Ouvre le sÃ©lecteur de toiles UNIQUEMENT quand le client demande explicitement Ã  choisir/voir des toiles PRINCIPALES du store HORS contexte lambrequin (ex: 'Quelle toile choisir?', 'Je veux voir les toiles', 'Avez-vous des Ã©chantillons de toile?'). âš ï¸ IMPORTANT : Si tu as proposÃ© un lambrequin enroulable (Ã‰TAPE 7), N'UTILISE PAS cet outil - utilise open_lambrequin_fabric_selector Ã  la place. APRÃˆS que le client a choisi, CONFIRME IMMÃ‰DIATEMENT son choix (ex: 'Parfait ! L'Orchestra Blanc est un excellent choix...').",
        inputSchema: jsonSchema({
          type: 'object',
          properties: {
            usage: {
              type: 'string',
              enum: ['main_canvas', 'valance'],
              description: "Type de toile : 'main_canvas' pour la toile principale du store, 'valance' pour le lambrequin enroulable uniquement.",
            },
            recommendation: {
              type: 'string',
              enum: ['standard', 'max', 'soltis'],
              description: "Recommandation de gamme : 'standard' pour Orchestra (par dÃ©faut), 'max' pour impermÃ©abilitÃ©/autonettoyant, 'soltis' pour lambrequin technique.",
            },
            pattern: {
              type: 'string',
              enum: ['uni', 'raye'],
              description: "Motif prÃ©fÃ©rÃ© : 'uni' pour couleur unie, 'raye' pour rayures.",
            },
          },
          required: ['usage'],
        }),
      }),
      open_lambrequin_fabric_selector: tool({
        description: "Ouvre le sÃ©lecteur SPÃ‰CIFIQUE de toiles techniques Soltis pour lambrequin enroulable motorisÃ©. ğŸ”¶ PRIORITÃ‰ : Utilise cet outil DÃˆS QUE tu as proposÃ© un lambrequin enroulable (Ã‰TAPE 7), ET que le client demande Ã  voir/choisir les toiles - MÃŠME s'il ne dit pas explicitement 'lambrequin'. EXEMPLES : 'voir les toiles', 'nuancier', 'choisir la couleur', 'montrer les options'. Si en doute, utilise CET OUTIL plutÃ´t que open_fabric_selector. N'utilise pas cet outil pour le lambrequin FIXE. APRÃˆS que le client a choisi, CONFIRME avec les avantages spÃ©cifiques (ex: 'Excellent ! La Soltis 86 vous permettra de garder la vue sur votre jardin...').",
        inputSchema: jsonSchema({
          type: 'object',
          properties: {
            context: {
              type: 'string',
              description: "Contexte optionnel : 'transparency' si le client veut garder la vue, 'thermal' s'il cherche la performance thermique.",
            },
          },
          required: [],
        }),
      }),
    },
  });

  // 5. Retourner le stream UI attendu par DefaultChatTransport
  console.log('ğŸ“¤ Envoi de la rÃ©ponse streaming...');
  return result.toUIMessageStreamResponse({
    originalMessages: messages,
  });
  } catch (error) {
    console.error('âŒ Erreur dans /api/chat:', error);
    return new Response(JSON.stringify({ 
      error: error instanceof Error ? error.message : 'Unknown error' 
    }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    });
  }
}